<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendPulse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- =================================================================
    //  ████████╗ ██████╗ ██████╗  █████╗  ██████╗  ██████╗
    //  ╚══██╔══╝██╔════╝ ██╔══██╗██╔══██╗██╔═══██╗██╔════╝
    //     ██║   ██║  ███╗██████╔╝███████║██║   ██║██║  ███╗
    //     ██║   ██║   ██║██╔══██╗██╔══██║██║   ██║██║   ██║
    //     ██║   ╚██████╔╝██║  ██║██║  ██║╚██████╔╝╚██████╔╝
    //     ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝  ╚═════╝
    //  This single file contains all HTML, CSS, and JavaScript.
    // ================================================================= -->

    <!-- =================================================================
    //  ██████╗ ███████╗███████╗
    //  ██╔══██╗██╔════╝██╔════╝
    //  ██████╔╝█████╗  █████╗
    //  ██╔══██╗██╔══╝  ██╔══╝
    //  ██║  ██║███████╗███████╗
    //  ╚═╝  ╚═╝╚══════╝╚══════╝
    // ================================================================= -->
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-accent: #9333ea; /* Purple */
            --secondary-accent: #08f7fe; /* Neon Blue/Cyan */
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #333;
            --font-primary: 'Poppins', sans-serif;
            --font-display: 'Orbitron', sans-serif;
        }

        /* --- Global Styles & Resets --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .hidden {
            display: none !important;
        }

        /* --- Navbar --- */
        .navbar {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--secondary-accent);
            text-shadow: 0 0 5px var(--secondary-accent);
            cursor: pointer;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 25px;
        }

        .nav-menu li a {
            color: var(--text-color);
            text-decoration: none;
            padding: 5px 10px;
            transition: color 0.3s, background-color 0.3s;
            border-radius: 5px;
        }

        .nav-menu li a:hover,
        .nav-menu li a.active {
            color: var(--secondary-accent);
        }

        .nav-auth .btn, .nav-user-profile {
            font-size: 0.9rem;
        }
        
        .nav-user-profile {
            position: relative;
            cursor: pointer;
            background-color: var(--surface-color);
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid var(--primary-accent);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: 120%;
            right: 0;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .nav-user-profile:hover .user-dropdown {
            display: block;
        }
        .user-dropdown a {
            display: block;
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
        }
        .user-dropdown a:hover {
            background-color: var(--primary-accent);
        }

        /* --- Main Content & Views --- */
        main {
            padding: 40px 0;
        }

        .view-title {
            font-family: var(--font-display);
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            color: var(--secondary-accent);
            text-shadow: 0 0 10px var(--secondary-accent);
        }

        /* --- Trend Cards --- */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .trend-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }

        .trend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.4);
        }

        .trend-card .hashtag {
            font-family: var(--font-display);
            color: var(--primary-accent);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .trend-card .link {
            color: var(--secondary-accent);
            text-decoration: none;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .trend-card .link:hover {
            text-decoration: underline;
        }

        .trend-meta {
            margin-top: auto;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .trend-actions {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vote-button {
            background: none;
            border: 1px solid var(--primary-accent);
            color: var(--primary-accent);
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .vote-button:hover:not(:disabled) {
            background-color: var(--primary-accent);
            color: white;
        }
        .vote-button:disabled {
            border-color: var(--text-muted);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .vote-count {
            font-weight: bold;
            color: var(--secondary-accent);
        }

        /* --- For U Page Specifics --- */
        #for-u-view .for-u-layout {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 40px;
        }
        .leaderboard {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .leaderboard h3 {
            font-family: var(--font-display);
            margin-bottom: 20px;
            color: var(--secondary-accent);
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* --- Modals / Popups --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--surface-color);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 1px solid var(--primary-accent);
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.5);
        }
        .modal-content h2 {
            font-family: var(--font-display);
            margin-bottom: 15px;
            color: var(--secondary-accent);
        }
        .modal-content p {
            margin-bottom: 25px;
        }

        /* --- Buttons --- */
        .btn {
            background-color: var(--primary-accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        .btn:hover {
            background-color: #a855f7; /* Lighter purple */
        }
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--primary-accent);
            color: var(--primary-accent);
        }
        .btn-secondary:hover {
            background-color: var(--primary-accent);
            color: white;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 1rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-accent);
        }

        /* --- Preferences Checkboxes --- */
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            text-align: left;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group input {
            margin-right: 10px;
            accent-color: var(--primary-accent);
        }
        
        /* --- AI Prediction Loader --- */
        .ai-prediction-box {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed var(--secondary-accent);
            border-radius: 5px;
            background-color: rgba(8, 247, 254, 0.05);
            text-align: center;
        }
        
        .ai-prediction-box .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--secondary-accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- =================================================================
    //  ██╗  ██╗████████╗███╗   ███╗██╗     
    //  ██║  ██║╚══██╔══╝████╗ ████║██║     
    //  ███████║   ██║   ██╔████╔██║██║     
    //  ██╔══██║   ██║   ██║╚██╔╝██║██║     
    //  ██║  ██║   ██║   ██║ ╚═╝ ██║███████╗
    //  ╚═╝  ╚═╝   ╚═╝   ╚═╝     ╚═╝╚══════╝
    // ================================================================= -->
    <header class="navbar">
        <div class="container nav-container">
            <h1 class="nav-logo" id="logo">TrendPulse</h1>
            <nav>
                <ul class="nav-menu">
                    <li><a href="#" data-view="top-trends-view">Top Trends</a></li>
                    <li><a href="#" data-view="submit-view">Submit</a></li>
                    <li><a href="#" id="nav-trending-board">Trending Board</a></li>
                    <li><a href="#" data-view="about-view">About</a></li>
                </ul>
            </nav>
            <div class="nav-auth">
                <button id="sign-in-btn" class="btn">Sign In</button>
                <div id="user-profile-container" class="nav-user-profile hidden">
                    <span id="user-email-display"></span>
                    <div class="user-dropdown">
                        <a href="#" id="sign-out-btn">Sign Out</a>
                        <a href="#" id="switch-account-btn" class="hidden">Sign in with work/school</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Default View: Top Trends (for guests & personal users) -->
        <div id="top-trends-view" class="view">
            <h2 class="view-title">Top Trends</h2>
            <div id="top-trends-grid" class="trends-grid">
                <!-- Trend cards will be injected here -->
            </div>
        </div>

        <!-- Submit Trend View -->
        <div id="submit-view" class="view hidden">
            <h2 class="view-title">Submit a New Trend</h2>
            <form id="submit-trend-form" style="max-width: 600px; margin: auto;">
                <div class="form-group">
                    <label for="trend-hashtag">Hashtag</label>
                    <input type="text" id="trend-hashtag" placeholder="#FutureOfAI" required>
                </div>
                <div class="form-group">
                    <label for="trend-link">Source Link (YouTube, TikTok, etc.)</label>
                    <input type="url" id="trend-link" placeholder="https://..." required>
                </div>
                 <div class="form-group">
                    <label for="trend-category">Category</label>
                    <select id="trend-category" required style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 1rem;">
                        <!-- Categories will be populated by JS -->
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Submit Trend</button>
            </form>
        </div>

        <!-- Premium View: Trending Board -->
        <div id="trending-board-view" class="view hidden">
            <h2 class="view-title">Trending Board</h2>
            <div style="background-color: var(--surface-color); padding: 20px; border-radius: 10px;">
                <canvas id="trending-chart"></canvas>
            </div>
        </div>

        <!-- Premium View: For U -->
        <div id="for-u-view" class="view hidden">
            <h2 class="view-title">For U</h2>
            <div class="for-u-layout">
                <div id="for-u-trends-grid" class="trends-grid">
                    <!-- Personalized trend cards injected here -->
                </div>
                <div class="leaderboard">
                    <h3>Trending in Your Categories</h3>
                    <div id="leaderboard-content">
                        <!-- Leaderboard items injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- About View -->
        <div id="about-view" class="view hidden">
            <h2 class="view-title">About TrendPulse</h2>
            <p style="text-align: center; max-width: 800px; margin:auto;">TrendPulse is a simulated platform for identifying and predicting emerging cultural, technological, and market trends. By leveraging community submissions and data analysis, we provide insights for both casual observers and strategic business planners. Sign in with a work or school email to unlock premium features and personalized insights.</p>
        </div>
    </main>

    <!-- Modals -->
    <div id="premium-access-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Premium Access Required</h2>
            <p>Please sign in with a company or school email to view the Trending Board.</p>
            <button id="modal-login-btn" class="btn">Log In</button>
        </div>
    </div>
    
    <div id="trend-detail-modal" class="modal-overlay hidden">
        <div id="trend-detail-content" class="modal-content">
            <!-- Dynamic content injected here -->
        </div>
    </div>

    <div id="preferences-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Welcome! Set Your Preferences</h2>
            <p>Select categories you're interested in to personalize your feed.</p>
            <form id="preferences-form">
                <div id="preferences-checkboxes" class="preferences-grid">
                    <!-- Checkboxes injected here -->
                </div>
                <button type="submit" class="btn">Save & Continue</button>
            </form>
        </div>
    </div>

    <footer>
        <p>© 2024 TrendPulse. All Rights Reserved.</p>
    </footer>

    <!-- =================================================================
    //    ██╗   ██╗███████╗
    //    ██║   ██║██╔════╝
    //    ██║   ██║███████╗
    //    ╚██╗ ██╔╝╚════██║
    //     ╚████╔╝ ███████║
    //      ╚═══╝  ╚══════╝
    // ================================================================= -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- =================================================================
    //  ███████╗██╗██████╗ ███████╗██████╗  █████╗ ███████╗███████╗
    //  ██╔════╝██║██╔══██╗██╔════╝██╔══██╗██╔══██╗██╔════╝██╔════╝
    //  █████╗  ██║██████╔╝█████╗  ██████╔╝███████║█████╗  ███████╗
    //  ██╔══╝  ██║██╔══██╗██╔══╝  ██║  ██║██╔══██║██╔══╝  ╚════██║
    //  ██║     ██║██║  ██║███████╗██║  ██║██║  ██║███████╗███████║
    //  ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝
    // ================================================================= -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            getDoc,
            setDoc,
            onSnapshot,
            query,
            where,
            orderBy,
            limit,
            increment,
            updateDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ==================================================
        // === 1. FIREBASE CONFIG & INITIALIZATION ========
        // ==================================================

        // IMPORTANT: Replace this with your own Firebase project configuration!
          const firebaseConfig = {
            apiKey: "AIzaSyD7Tmo8AF9lwmLo_I9WAuWHwg0W8jw9oYI",
            authDomain: "trend-pulse-new.firebaseapp.com",
            projectId: "trend-pulse-new",
            storageBucket: "trend-pulse-new.firebasestorage.app",
            messagingSenderId: "342759464672",
            appId: "1:342759464672:web:a0b1992d5c99d8368b7a85",
            measurementId: "G-S30JCQCRRM"
          };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==================================================
        // === 2. GLOBAL STATE & CONSTANTS =================
        // ==================================================
        const appState = {
            user: null,
            userProfile: null, // Stores user data from Firestore (role, preferences)
            role: 'guest', // 'guest', 'personal', 'premium'
            currentView: 'top-trends-view',
            unsubscribeListeners: [], // To clean up real-time listeners
        };

        const CATEGORIES = [
            'Art', 'Business', 'Climate', 'Design', 'Education', 'Fashion', 'Food',
            'Gaming', 'Marketing', 'Music', 'Politics', 'Technology', 'Wellness'
        ];
        
        const PREMIUM_DOMAINS_REGEX = /\.(edu|org)$/i;
        const PREMIUM_COMPANY_DOMAINS = ['trendpulse.com', 'company.com']; // Example company domains

        // ==================================================
        // === 3. DOM ELEMENT REFERENCES ====================
        // ==================================================
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-menu a');
        const signInBtn = document.getElementById('sign-in-btn');
        const modalLoginBtn = document.getElementById('modal-login-btn');
        const userProfileContainer = document.getElementById('user-profile-container');
        const userEmailDisplay = document.getElementById('user-email-display');
        const switchAccountBtn = document.getElementById('switch-account-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const logo = document.getElementById('logo');

        // Modals
        const premiumAccessModal = document.getElementById('premium-access-modal');
        const preferencesModal = document.getElementById('preferences-modal');
        const trendDetailModal = document.getElementById('trend-detail-modal');

        // Grids & Content Areas
        const topTrendsGrid = document.getElementById('top-trends-grid');
        const forYouTrendsGrid = document.getElementById('for-u-trends-grid');
        const leaderboardContent = document.getElementById('leaderboard-content');
        
        // Forms
        const submitForm = document.getElementById('submit-trend-form');
        const preferencesForm = document.getElementById('preferences-form');
        const trendCategorySelect = document.getElementById('trend-category');

        // ==================================================
        // === 4. UI & VIEW MANAGEMENT ======================
        // ==================================================
        
        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
            appState.currentView = viewId;
            updateActiveNav(viewId);
        }

        function updateActiveNav(activeViewId) {
            navLinks.forEach(link => {
                if (link.dataset.view === activeViewId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        function updateUIforAuthState() {
            if (appState.user) {
                signInBtn.classList.add('hidden');
                userProfileContainer.classList.remove('hidden');
                userEmailDisplay.textContent = appState.user.email;
                
                if(appState.role === 'personal') {
                    switchAccountBtn.classList.remove('hidden');
                } else {
                    switchAccountBtn.classList.add('hidden');
                }
                
                renderContentForUser();
            } else {
                // Logged out state
                signInBtn.classList.remove('hidden');
                userProfileContainer.classList.add('hidden');
                switchAccountBtn.classList.add('hidden');
                showView('top-trends-view');
                fetchAndRenderTrends(topTrendsGrid, 'guest');
            }
        }
        
        function renderContentForUser() {
            cleanupListeners(); // Clear old listeners before setting new ones
            
            if (appState.role === 'premium') {
                if (!appState.userProfile?.preferences) {
                    showPreferencesModal();
                } else {
                    showView('for-u-view');
                    fetchAndRenderForYouContent();
                }
            } else { // 'personal' or 'guest'
                showView('top-trends-view');
                fetchAndRenderTrends(topTrendsGrid, appState.role);
            }
        }
        
        // ==================================================
        // === 5. AUTHENTICATION LOGIC ======================
        // ==================================================
        
        function getUserRole(email) {
            if (!email) return 'guest';
            const domain = email.split('@')[1];
            if (email.endsWith('@gmail.com')) {
                return 'personal';
            }
            if (PREMIUM_DOMAINS_REGEX.test(email) || PREMIUM_COMPANY_DOMAINS.includes(domain)) {
                return 'premium';
            }
            return 'personal'; // Default to personal if not a recognized premium domain
        }

        async function handleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Authentication failed:", error);
                alert("Sign-in failed. Please try again.");
            }
        }

        function handleSignOut() {
            signOut(auth).catch(error => console.error("Sign out failed:", error));
        }

        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            if (user) {
                appState.user = user;
                appState.role = getUserRole(user.email);
                
                // Fetch or create user profile in Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    appState.userProfile = userDocSnap.data();
                } else {
                    const newUserProfile = {
                        email: user.email,
                        role: appState.role,
                        createdAt: Timestamp.now(),
                        votedOn: []
                    };
                    await setDoc(userDocRef, newUserProfile);
                    appState.userProfile = newUserProfile;
                }
            } else {
                appState.user = null;
                appState.userProfile = null;
                appState.role = 'guest';
            }
            updateUIforAuthState();
        });

        // ==================================================
        // === 6. FIRESTORE & DATA LOGIC ====================
        // ==================================================

        function cleanupListeners() {
            appState.unsubscribeListeners.forEach(unsub => unsub());
            appState.unsubscribeListeners = [];
        }

        function fetchAndRenderTrends(gridElement, role) {
            const trendsQuery = query(collection(db, "trends"), orderBy("createdAt", "desc"), limit(20));
            
            const unsubscribe = onSnapshot(trendsQuery, (snapshot) => {
                gridElement.innerHTML = ''; // Clear previous content
                if (snapshot.empty) {
                    gridElement.innerHTML = `<p>No trends submitted yet. Be the first!</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const trend = { id: doc.id, ...doc.data() };
                    const trendCard = createTrendCard(trend, role);
                    gridElement.appendChild(trendCard);
                });
            }, (error) => {
                console.error("Error fetching trends:", error);
                gridElement.innerHTML = `<p>Error loading trends. Please try again later.</p>`;
            });
            appState.unsubscribeListeners.push(unsubscribe);
        }

        function fetchAndRenderForYouContent() {
            const prefs = appState.userProfile?.preferences;
            if (!prefs || prefs.length === 0) {
                forYouTrendsGrid.innerHTML = `<p>Please set your preferences to see personalized trends.</p>`;
                leaderboardContent.innerHTML = '';
                return;
            }

            // Fetch trends for grid
            const trendsQuery = query(collection(db, "trends"), where("category", "in", prefs));
            const trendsUnsubscribe = onSnapshot(trendsQuery, (snapshot) => {
                forYouTrendsGrid.innerHTML = '';
                 if (snapshot.empty) {
                    forYouTrendsGrid.innerHTML = `<p>No trends found for your selected categories.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const trend = { id: doc.id, ...doc.data() };
                    const trendCard = createTrendCard(trend, 'premium');
                    forYouTrendsGrid.appendChild(trendCard);
                });
            });

            // Fetch trends for leaderboard
            const leaderboardQuery = query(collection(db, "trends"), where("category", "in", prefs), orderBy("voteCount", "desc"), limit(10));
            const leaderboardUnsubscribe = onSnapshot(leaderboardQuery, (snapshot) => {
                leaderboardContent.innerHTML = '';
                snapshot.forEach(doc => {
                    const trend = { id: doc.id, ...doc.data() };
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span>${trend.hashtag}</span>
                        <span class="vote-count">${trend.voteCount}</span>
                    `;
                    leaderboardContent.appendChild(item);
                });
            });

            appState.unsubscribeListeners.push(trendsUnsubscribe, leaderboardUnsubscribe);
        }
        
        async function handleVote(trendId) {
            if (!appState.user || !appState.userProfile) {
                alert("Please sign in to vote.");
                return;
            }

            if (appState.userProfile.votedOn?.includes(trendId)) {
                alert("You have already voted for this trend.");
                return;
            }

            const userDocRef = doc(db, "users", appState.user.uid);
            const trendDocRef = doc(db, "trends", trendId);
            
            try {
                // This is a simple update, a transaction is safer for race conditions
                await updateDoc(trendDocRef, {
                    voteCount: increment(1)
                });
                await updateDoc(userDocRef, {
                    votedOn: [...(appState.userProfile.votedOn || []), trendId]
                });
                // Optimistically update local state for faster UI response
                appState.userProfile.votedOn.push(trendId);
                // Re-render card to disable button
                const card = document.querySelector(`.trend-card[data-id="${trendId}"]`);
                if(card) {
                    const button = card.querySelector('.vote-button');
                    if(button) button.disabled = true;
                }
            } catch (error) {
                console.error("Error voting:", error);
                alert("Could not register your vote. Please try again.");
            }
        }
        
        async function handleSubmitTrend(e) {
            e.preventDefault();
            if(!appState.user) {
                alert("You must be logged in to submit a trend.");
                return;
            }
            
            const hashtag = document.getElementById('trend-hashtag').value.trim();
            const link = document.getElementById('trend-link').value.trim();
            const category = document.getElementById('trend-category').value;
            
            if(!hashtag.startsWith('#') || hashtag.length < 2 || !link || !category) {
                alert("Please fill out all fields correctly. Hashtag must start with #.");
                return;
            }
            
            try {
                await addDoc(collection(db, "trends"), {
                   hashtag: hashtag,
                   link: link,
                   category: category,
                   authorId: appState.user.uid,
                   authorEmail: appState.user.email,
                   createdAt: Timestamp.now(),
                   voteCount: 0
                });
                alert("Trend submitted successfully!");
                submitForm.reset();
                showView(appState.role === 'premium' ? 'for-u-view' : 'top-trends-view');
            } catch (error) {
                console.error("Error submitting trend:", error);
                alert("Failed to submit trend. Please try again.");
            }
        }

        async function handleSavePreferences(e) {
            e.preventDefault();
            const selectedCategories = Array.from(document.querySelectorAll('#preferences-checkboxes input:checked'))
                                             .map(cb => cb.value);

            if (selectedCategories.length === 0) {
                alert("Please select at least one category.");
                return;
            }

            const userDocRef = doc(db, "users", appState.user.uid);
            try {
                await updateDoc(userDocRef, {
                    preferences: selectedCategories
                });
                appState.userProfile.preferences = selectedCategories; // Update local state
                preferencesModal.classList.add('hidden');
                renderContentForUser(); // Re-render content with new preferences
            } catch (error) {
                console.error("Error saving preferences:", error);
                alert("Failed to save preferences. Please try again.");
            }
        }

        // ==================================================
        // === 7. COMPONENT & CARD RENDERING ==============
        // ==================================================
        
        function createTrendCard(trend, role) {
            const card = document.createElement('div');
            card.className = 'trend-card';
            card.dataset.id = trend.id;

            const isVoted = appState.userProfile?.votedOn?.includes(trend.id);
            const canVote = role === 'personal' || role === 'premium';
            
            let metaInfo = '';
            if (role === 'premium') {
                metaInfo = `
                    <div class="trend-meta">
                        Posted by: ${trend.authorEmail} on ${trend.createdAt.toDate().toLocaleDateString()}
                    </div>
                `;
            }
            
            let actions = '';
            if(role === 'guest') {
                actions = `<button class="btn-secondary" onclick="document.getElementById('sign-in-btn').click()">Sign in to Vote</button>`;
            } else if (canVote) {
                 actions = `
                    <button class="vote-button" ${isVoted ? 'disabled' : ''} data-trend-id="${trend.id}">
                        ${isVoted ? 'Voted' : 'Vote Up'}
                    </button>
                    ${role === 'premium' ? `<span class="vote-count">${trend.voteCount} Votes</span>` : ''}
                `;
            }
            
            card.innerHTML = `
                <div class="hashtag">${trend.hashtag}</div>
                <a href="${trend.link}" target="_blank" class="link">${trend.link}</a>
                ${metaInfo}
                <div class="trend-actions">
                    ${actions}
                </div>
            `;
            
            // Add event listeners for premium-only card clicks
            if (role === 'premium') {
                card.style.cursor = 'pointer';
                card.addEventListener('click', (e) => {
                    // Prevent modal opening if a link or button inside the card was clicked
                    if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                        showTrendDetailModal(trend);
                    }
                });
            }
            
            // This needs to be done after innerHTML is set
            const voteButton = card.querySelector('.vote-button');
            if (voteButton) {
                voteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click event when voting
                    handleVote(e.target.dataset.trendId)
                });
            }

            return card;
        }

        function showTrendDetailModal(trend) {
            const modalContent = document.getElementById('trend-detail-content');
            modalContent.innerHTML = `
                <h2 class="hashtag">${trend.hashtag}</h2>
                <p><strong>Source:</strong> <a href="${trend.link}" target="_blank" class="link">${trend.link}</a></p>
                <p><strong>Category:</strong> ${trend.category}</p>
                <p style="color: var(--text-muted); font-style: italic;">"This trend is currently rising and expected to grow."</p>
                <div class="ai-prediction-box">
                    <p>Click below for an AI-generated popularity forecast.</p>
                    <button id="ai-predict-btn" class="btn-secondary">Analyze Trend</button>
                    <div id="ai-result" class="hidden" style="margin-top: 15px;"></div>
                </div>
                <button id="close-detail-modal-btn" class="btn" style="margin-top:20px;">Close</button>
            `;
            trendDetailModal.classList.remove('hidden');

            document.getElementById('ai-predict-btn').addEventListener('click', () => {
                const resultDiv = document.getElementById('ai-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `<div class="loader"></div><p>Analyzing signals...</p>`;
                
                setTimeout(() => {
                    resultDiv.innerHTML = `<p style="color: var(--secondary-accent); font-weight: bold;">Analysis complete: This trend shows a 75% probability of peaking in the next 3 months.</p>`;
                }, 2500);
            });

            document.getElementById('close-detail-modal-btn').addEventListener('click', () => {
                trendDetailModal.classList.add('hidden');
            });
        }
        
        function showPreferencesModal() {
            const container = document.getElementById('preferences-checkboxes');
            container.innerHTML = CATEGORIES.map(cat => `
                <div class="checkbox-group">
                    <input type="checkbox" id="pref-${cat}" name="preference" value="${cat}">
                    <label for="pref-${cat}">${cat}</label>
                </div>
            `).join('');
            preferencesModal.classList.remove('hidden');
        }

        // ==================================================
        // === 8. CHART.JS LOGIC ============================
        // ==================================================
        let trendingChart = null;

        async function renderTrendingBoard() {
            premiumAccessModal.classList.add('hidden');
            showView('trending-board-view');
            
            const trendsQuery = query(collection(db, "trends"), orderBy("voteCount", "desc"), limit(10));
            onSnapshot(trendsQuery, (snapshot) => {
                const labels = [];
                const data = [];
                snapshot.forEach(doc => {
                    const trend = doc.data();
                    labels.push(trend.hashtag);
                    data.push(trend.voteCount);
                });
                
                if (trendingChart) {
                    trendingChart.destroy();
                }
                const ctx = document.getElementById('trending-chart').getContext('2d');
                trendingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Votes',
                            data: data,
                            backgroundColor: 'rgba(147, 51, 234, 0.6)',
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                           x: { ticks: { color: 'white' } },
                           y: { ticks: { color: 'white' } }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Top 10 Voted Trends',
                                color: 'white',
                                font: { size: 18, family: 'Orbitron' }
                            }
                        }
                    }
                });
            });
        }

        // ==================================================
        // === 9. EVENT LISTENERS & INITIALIZATION ==========
        // ==================================================
        
        function init() {
             // Populate category dropdowns
            const categoryOptions = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            trendCategorySelect.innerHTML = categoryOptions;

            // Nav link routing
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.target.dataset.view;
                    if(viewId) showView(viewId);
                });
            });
            logo.addEventListener('click', () => renderContentForUser());

            // Auth buttons
            signInBtn.addEventListener('click', handleSignIn);
            modalLoginBtn.addEventListener('click', handleSignIn);
            signOutBtn.addEventListener('click', handleSignOut);
            switchAccountBtn.addEventListener('click', handleSignIn);

            // Special nav link: Trending Board
            document.getElementById('nav-trending-board').addEventListener('click', (e) => {
                e.preventDefault();
                if (appState.role === 'premium') {
                    renderTrendingBoard();
                } else {
                    premiumAccessModal.classList.remove('hidden');
                }
            });

            // Close modals by clicking overlay
            [premiumAccessModal, trendDetailModal, preferencesModal].forEach(modal => {
                modal.addEventListener('click', e => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Form submissions
            submitForm.addEventListener('submit', handleSubmitTrend);
            preferencesForm.addEventListener('submit', handleSavePreferences);

            // Initial UI state is handled by onAuthStateChanged
        }

        // Run app initialization on DOM load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
