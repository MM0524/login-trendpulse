<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendPulse | Prioritized Edition</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Main (client helpers) -->
    <script src="main.js"></script>
    <!-- Trend Analysis API -->
    <script src="netlify/functions/analyze-trend.js"></script>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23A100FF'/></svg>">
    <style>
        /* --- General Setup & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            /* --- #A100FF & #0F1021 COLOR SCHEME --- */
            --bg-color: #0F1021;
            --surface-color: #191a2e;
            --primary-color: #A100FF;
            --primary-light: #b540ff;
            --accent-color: var(--primary-color);
            --accent-light: var(--primary-light); 
            --text-color: #e3e8f0;
            --text-muted-color: #8a8da0;
            --border-color: #2d2e49;
            --header-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; }

        /* --- Loading Animation --- */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loader-overlay.loader-hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loader-pulse {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loader-pulse div {
            position: absolute;
            border: 4px solid var(--primary-light);
            opacity: 1;
            border-radius: 50%;
            animation: pulse 1.2s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }
        .loader-pulse div:nth-child(2) {
            animation-delay: -0.6s;
        }
        @keyframes pulse {
            0% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                top: 0px;
                left: 0px;
                width: 72px;
                height: 72px;
                opacity: 0;
            }
        }
        
        /* --- ANIMATION ADDITION: Keyframes for animations --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* --- Header & Navigation --- */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; height: var(--header-height); animation: fadeIn 0.5s ease-out; }
        .logo { font-size: 1.8rem; font-weight: 700; cursor: pointer; transition: transform 0.3s ease; }
        .logo:hover { transform: scale(1.05); }
        .logo-trend { color: var(--primary-light); }
        .nav-links { display: flex; gap: 1.5rem; list-style: none; }
        .nav-links a { color: var(--text-muted-color); text-decoration: none; font-weight: 500; transition: color 0.3s ease, transform 0.3s ease; }
        .nav-links a:hover { color: var(--primary-color); transform: translateY(-2px); }
        .nav-actions { position: relative; display: flex; align-items: center; gap: 0.75rem; }
        .language-switcher { margin-right: 1rem; }
        .language-switcher .btn { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
        .lang-text { font-size: 1.2rem; }
        .lang-label { font-weight: 500; }
        .hamburger-menu { display: none; }
        
        /* --- Buttons --- */
        .btn { padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); transform: translateY(-2px); }
        .btn-secondary { background: var(--surface-color); color: var(--text-muted-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); color: var(--text-color); transform: translateY(-2px); }
        .btn-outline { background: transparent; color: var(--primary-light); border: 1px solid var(--primary-light); font-size: 0.8rem; padding: 0.3rem 0.8rem; }
        .btn-outline:hover { background: var(--primary-light); color: white; transform: translateY(-2px); }
        .analyze-trend-btn { background: transparent; color: var(--primary-light); border: 1px solid var(--primary-light); font-size: 0.8rem; padding: 0.3rem 0.8rem; margin-right: 0.5rem; }
        .analyze-trend-btn:hover { background: var(--primary-light); color: white; }

        /* --- Main Content & Views --- */
        .main-container, .for-u-container { animation: slideInUp 0.6s ease-out; }
        .main-container { display: grid; grid-template-columns: 1fr; gap: 2rem; padding: 2rem; max-width: 896px; margin: 0 auto; }
        .for-u-container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; padding: 2rem; max-width: 1400px; margin: auto; }
        .demo-banner { grid-column: 1 / -1; background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .trending-container, .for-u-content, .leaderboard-panel { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .trending-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .trending-title-group { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 600; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; }
        .filter-btn { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .filter-btn:hover { background-color: var(--border-color); color: var(--text-color); transform: translateY(-2px); }
        .filter-btn.active { background-color: var(--primary-color); color: white; font-weight: 500; border-color: var(--primary-color); transform: scale(1.05); }
        
        /* --- Trend Card --- */
        .trend-card { 
            background-color: var(--bg-color); padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .trend-card:nth-child(1) { animation-delay: 0.05s; }
        .trend-card:nth-child(2) { animation-delay: 0.1s; }
        .trend-card:nth-child(3) { animation-delay: 0.15s; }
        .trend-card:nth-child(4) { animation-delay: 0.2s; }
        .trend-card:nth-child(5) { animation-delay: 0.25s; }
        .trend-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .trend-title { font-size: 1.25rem; font-weight: 600; cursor: pointer; transition: color 0.3s; }
        .trend-title:hover { color: var(--primary-light); }
        .trend-meta { text-align: right; font-size: 0.8rem; color: var(--text-muted-color); white-space: nowrap; }
        .trend-description { margin-bottom: 1rem; color: var(--text-muted-color); }
        
        .trend-ai-insight {
            background-color: rgba(161, 0, 255, 0.05); border-left: 3px solid var(--primary-color); font-size: 0.85rem; color: var(--text-muted-color); font-style: italic; border-radius: 4px;
            max-height: 0; opacity: 0; overflow: hidden; margin: 0; padding: 0 1rem; transition: all 0.5s ease-in-out;
        }
        body.work-account-view .trend-ai-insight { max-height: 150px; opacity: 1; margin: 0.5rem 0 1rem 0; padding: 0.75rem 1rem; }
        
        .loading-spinner { width: 20px; height: 20px; border: 2px solid rgba(161, 0, 255, 0.1); border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ai-insight-content { text-align: left; line-height: 1.3; font-size: 0.8rem; max-width: 100%; }
        .ai-insight-content h4 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary-light); }
        .ai-insight-content p { margin-bottom: 0.4rem; font-size: 0.75rem; }
        .ai-insight-content ul { margin: 0.3rem 0; padding-left: 1rem; }
        .ai-insight-content li { margin-bottom: 0.2rem; font-size: 0.7rem; }
        .ai-insight-content strong { color: var(--primary-light); font-weight: 600; }
        
        .ai-status-indicator { position: fixed; top: 80px; right: 20px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-muted-color); z-index: 1001; transition: all 0.3s ease; }
        .ai-status-indicator.online { border-color: #4CAF50; color: #4CAF50; }
        .ai-status-indicator.offline { border-color: #f44336; color: #f44336; }

        .trend-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .trend-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; }
        .tag.category { background-color: var(--accent-color); color: white; }
        .tag.hashtag { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 400; }
        .tag.hashtag:hover { transform: translateY(-2px); border-color: var(--primary-light); background-color: var(--border-color); color: var(--text-color); }
        .tag.status { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); }
        .tag.status.past { background-color: #2b2434; border-color: #4a3a5a; color: #caa7ff; }

        .trend-actions { display: flex; align-items: center; gap: 1rem; }
        .btn-follow { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); display: flex; align-items: center; gap: 0.5rem; }
        .btn-follow:hover { background-color: var(--border-color); color: var(--text-color); }
        .btn-follow.followed { background-color: var(--accent-color); color: white; border-color: var(--accent-light); }
        #trends-footer { text-align: center; margin-top: 1.5rem; }
        
        .leaderboard-panel h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .leaderboard-widget { margin-bottom: 1.5rem; }
        .leaderboard-widget h4 { color: var(--primary-light); margin-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .leaderboard-widget ol { list-style-position: inside; padding: 0; margin: 0; }
        .leaderboard-widget li { background-color: var(--bg-color); padding: 0.6rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; justify-content: space-between; }
        .leaderboard-widget li .stat-display { font-size: 0.8rem; color: var(--text-muted-color); }

        .vote-count, .trend-meta-date, .view-source-btn, .trend-meta-submitter { display: none; }
        .btn-follow { display: none; }
        body.work-account-view .btn-follow { display: flex; }
        body.work-account-view .vote-count, body.work-account-view .trend-meta-date, body.work-account-view .view-source-btn, body.work-account-view .trend-meta-submitter { display: inline-block; }
        
        .dropdown { display: none; position: absolute; top: 110%; right: 0; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; min-width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; padding: 0.5rem 0; }
        .dropdown.show { display: block; }
        .dropdown-header { padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-muted-color); border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem; }
        .dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; cursor: pointer; }
        .dropdown-item:hover { background-color: var(--border-color); }
        .dropdown-item svg { width: 18px; height: 18px; stroke: var(--primary-light); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 16, 33, 0.85); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--surface-color); padding: 1rem; border-radius: 10px; width: 85%; max-width: 380px; text-align: center; position: relative; border: 1px solid var(--border-color);
            transform: scale(0.95) translateY(10px); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0;
        }
        .modal-overlay.show .modal-content { transform: scale(1) translateY(0); opacity: 1; }

        .modal-close { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: var(--text-muted-color); font-size: 1.2rem; cursor: pointer; }
        .modal-title { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--primary-light); }
        #login-choice-modal .modal-actions { display: flex; flex-direction: column; gap: 0.75rem; }
        .btn-social { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 0.8rem; text-align: left; font-size: 0.95rem; }
        .btn-social:hover { background-color: var(--border-color); }
        .btn-social svg { width: 20px; height: 20px; stroke: var(--primary-light); }
        .preferences-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: left; margin-bottom: 1.5rem; }
        .preference-item label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .preference-item input { accent-color: var(--primary-color); }
        #trending-board-content { max-width: 800px; }
        #hot-trends-container canvas { width: 100%; max-height: 280px; }
        .leaderboards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .leaderboards-container h4, .leaderboard-panel h4 { color: var(--primary-light); margin-bottom: 0.5rem; }
        .leaderboards-container ol, .leaderboard-panel ol { list-style-position: inside; padding-left: 0; }
        .leaderboards-container li, .leaderboard-panel li { background-color: var(--bg-color); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; justify-content: space-between; }

        #ai-insight-modal .modal-content { max-width: 340px; width: 90%; padding: 0.75rem; }
        #ai-insight-modal .modal-body { max-height: 60vh; overflow-y: auto; }
        #ai-insight-modal .modal-title { font-size: 1rem; }
        #ai-insight-modal .ai-insight-content p { margin-bottom: 0.35rem; }
        #ai-insight-modal .ai-insight-content ul { margin: 0.25rem 0; }
        #ai-insight-modal .ai-insight-content li { margin-bottom: 0.2rem; }
        #ai-insight-modal .ai-insight-chart { margin-top: 0.6rem; }
        #ai-insight-modal .ai-insight-chart canvas { width: 100%; height: 160px; }

        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        
        .footer { background-color: var(--surface-color); border-top: 1px solid var(--border-color); margin-top: 4rem; padding: 3rem 0 1rem 0; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-section { display: flex; flex-direction: column; }
        .footer-title { color: var(--primary-light); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
        .footer-description { color: var(--text-muted-color); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem; }
        .footer-links { list-style: none; padding: 0; }
        .footer-links li { margin-bottom: 0.5rem; }
        .footer-links a { color: var(--text-muted-color); text-decoration: none; font-size: 0.9rem; transition: color 0.3s ease; }
        .footer-links a:hover { color: var(--primary-light); }
        .footer-contact p { color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .footer-bottom { border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin-left: auto; margin-right: auto; padding-left: 2rem; padding-right: 2rem; }
        .footer-bottom p { color: var(--text-muted-color); font-size: 0.9rem; }
        .footer-social { display: flex; gap: 1rem; }
        .social-link { color: var(--text-muted-color); font-size: 1.2rem; text-decoration: none; transition: color 0.3s ease, transform 0.3s ease; }
        .social-link:hover { color: var(--primary-light); transform: scale(1.2); }
        
        @media (max-width: 1024px) { .main-container, .for-u-container { grid-template-columns: 1fr; } .for-u-container { grid-auto-flow: dense; } .leaderboard-panel { grid-row: 1; } }
        @media (max-width: 768px) {
            .header { padding: 0 1rem; }
            .nav-links { position: fixed; top: var(--header-height); left: 0; width: 100%; height: calc(100vh - var(--header-height)); background-color: var(--bg-color); flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 2rem; gap: 2rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            nav.nav-active .nav-links { transform: translateX(0); }
            .hamburger-menu { display: flex; flex-direction: column; justify-content: space-around; width: 2rem; height: 2rem; background: transparent; border: none; cursor: pointer; padding: 0; z-index: 10; }
            .hamburger-menu span { width: 2rem; height: 0.25rem; background: var(--text-color); border-radius: 10px; transition: all 0.3s linear; transform-origin: 1px; }
            .hamburger-menu.active span:nth-child(1) { transform: rotate(45deg); }
            .hamburger-menu.active span:nth-child(2) { opacity: 0; transform: translateX(20px); }
            .hamburger-menu.active span:nth-child(3) { transform: rotate(-45deg); }
            .main-container, .for-u-container { padding: 1rem; }
            .footer-content { grid-template-columns: 1fr; text-align: center; padding: 0 1rem; }
            .footer-bottom { flex-direction: column; gap: 1rem; text-align: center; padding-left: 1rem; padding-right: 1rem; }
        }
        
        .hidden { display: none !important; }

        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
    </style>
</head>
<body>
    <!-- Loading Animation Markup -->
    <div class="loader-overlay" id="loader">
        <div class="loader-pulse">
            <div></div>
            <div></div>
        </div>
    </div>

    <header class="header">
        <div class="logo" id="logo"><span class="logo-trend">Trend</span><span class="logo-pulse">Pulse</span></div>
        <div class="ai-status-indicator" id="ai-status-indicator">
            <span id="ai-status-text">AI: Đang kiểm tra...</span>
        </div>
        <nav id="main-nav">
            <ul class="nav-links">
                <li><a href="#" id="nav-top-trends">Top Trends</a></li>
                <li><a href="#" id="nav-trending-board">Trending Board</a></li>
                <li id="nav-for-u" class="hidden"><a href="#">For U</a></li>
                <li><a href="#" id="nav-about">About</a></li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
             <div class="nav-actions">
                <div class="language-switcher">
                    <button class="btn btn-outline" id="language-toggle">VN</button>
                </div>
                <button class="btn btn-primary" id="sign-in-btn">Sign In</button>
                <div id="user-menu" class="hidden">
                    <button class="btn btn-secondary" id="user-email-btn"></button>
                    <div class="dropdown" id="user-dropdown">
                        <div class="dropdown-header" id="dropdown-user-email"></div>
                        <a href="#" class="dropdown-item" id="dropdown-work-school"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span>Sign in with Work/School</span></a>
                        <a href="#" class="dropdown-item" id="dropdown-sign-out"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>Sign Out</span></a>
                    </div>
                </div>
            </div>
            <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle navigation menu"><span></span><span></span><span></span></button>
        </div>
    </header>
    <main class="main-container" id="main-view-container">
        <div class="demo-banner"><h2>Welcome to TrendPulse</h2><p>Discover what’s next. Act before the rest.</p></div>
        <section class="trending-container">
            <div class="trending-header">
                <div class="trending-title-group" id="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span id="trending-header-text">Trending Now</span></div>
                 <button class="btn btn-secondary hidden" id="clear-filter-btn">Show All Trends</button>
            </div>
            <div class="filter-buttons" id="filter-buttons"></div>
            <div id="trends-list"></div>
            <div id="trends-footer"><button class="btn btn-primary" id="load-more-btn">Load More</button></div>
        </section>
    </main>
    <section class="for-u-container hidden" id="for-u-view-container">
        <div class="for-u-content">
            <div class="trending-header">
                <div class="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg><span>For You</span></div>
            </div>
            <div id="for-u-trends-list"></div>
            <div id="for-u-trends-footer"><button class="btn btn-primary" id="for-u-load-more-btn">Load More</button></div>
        </div>
        <aside class="leaderboard-panel" id="for-u-leaderboard-panel">
             <h3>Category Leaderboards</h3>
             <div id="for-u-leaderboards"></div>
        </aside>
    </section>
    <div class="modal-overlay" id="preferences-modal"><div class="modal-content"><button class="modal-close" data-close="preferences-modal" aria-label="Close preferences dialog">&times;</button><h3 class="modal-title">Welcome! Set Your Preferences</h3><p class="modal-body">Select the categories you're interested in for a personalized experience.</p><div class="preferences-grid" id="preferences-grid"></div><div class="modal-actions"><button class="btn btn-primary" id="save-preferences-btn">Save Preferences</button></div></div></div>
    <div class="modal-overlay" id="premium-modal"><div class="modal-content"><button class="modal-close" data-close="premium-modal" aria-label="Close premium dialog">&times;</button><h3 class="modal-title">Premium Access Required</h3><p class="modal-body">Please sign in with a company or school email to view the Trending Board.</p><div class="modal-actions"><button class="btn btn-primary" id="premium-login-btn">Log In</button></div></div></div>
    <div class="modal-overlay" id="login-choice-modal"><div class="modal-content"><button class="modal-close" data-close="login-choice-modal" aria-label="Close login dialog">&times;</button><h3 class="modal-title">Sign In</h3><p class="modal-body">Choose an account to continue to TrendPulse.</p><div class="modal-actions"><button class="btn btn-social" id="login-google-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>Sign in with Google</span></button><button class="btn btn-social" id="login-work-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span>Sign in with Work/School</span></button></div></div></div>
    <div class="modal-overlay" id="trending-board-modal"><div class="modal-content" id="trending-board-content"><button class="modal-close" data-close="trending-board-modal" aria-label="Close trending board dialog">&times;</button><h3 class="modal-title">Trending Board Dashboard</h3><div id="hot-trends-container"><h4>Currently Hot Trends (Overall)</h4><canvas id="hot-trends-chart"></canvas></div><div class="leaderboards-container" id="category-leaderboards"></div></div></div>
    <div class="modal-overlay" id="ai-insight-modal">
        <div class="modal-content">
            <button class="modal-close" data-close="ai-insight-modal" aria-label="Close AI insight dialog">&times;</button>
            <h3 class="modal-title" id="ai-insight-title">AI Insight</h3>
            <div id="ai-insight-body" class="modal-body ai-insight-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="about-modal"><div class="modal-content"><button class="modal-close" data-close="about-modal" aria-label="Close about dialog">&times;</button><h3 class="modal-title">About TrendPulse</h3><p class="modal-body">A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.</p></div></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4 class="footer-title">TrendPulse</h4>
                <p class="footer-description">Nền tảng phân tích và dự đoán xu hướng hàng đầu, giúp bạn nắm bắt những thay đổi mới nhất trong thế giới số.</p>
            </div>
            <div class="footer-section">
                <h4 class="footer-title">Liên kết nhanh</h4>
                <ul class="footer-links">
                    <li><a href="#" id="footer-top-trends">Top Trends</a></li>
                    <li><a href="#" id="footer-trending-board">Trending Board</a></li>
                    <li><a href="#" id="footer-about">About</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4 class="footer-title">Tính năng</h4>
                <ul class="footer-links">
                    <li>Phân tích AI</li>
                    <li>Dự đoán xu hướng</li>
                    <li>Bảng xếp hạng</li>
                    <li>Gợi ý cá nhân</li>
                </ul>
            </div>
            <div class="footer-section">
                <h4 class="footer-title">Liên hệ</h4>
                <div class="footer-contact">
                    <p>Email: info@trendpulse.com</p>
                    <p>Hỗ trợ: support@trendpulse.com</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 TrendPulse. Tất cả quyền được bảo lưu.</p>
            <div class="footer-social">
                <a href="#" class="social-link" aria-label="Facebook">📘</a>
                <a href="#" class="social-link" aria-label="Twitter">🐦</a>
                <a href="#" class="social-link" aria-label="LinkedIn">💼</a>
            </div>
        </div>
    </footer>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DATA ---
        let user = { isLoggedIn: false, email: null, accountType: null, preferences: [], hasSetPreferences: false, followedTrends: [] };
        const TRENDS_PER_PAGE = 5;
        let displayedTrends = { main: 0, forU: 0 };
        let currentFilter = { type: 'category', value: 'All' };
        let currentView = 'main';
        let hotTrendsChart = null;
        // --- LANGUAGE SUPPORT ---
        let currentLanguage = localStorage.getItem('lang') || 'vi';
        const translations = {
            vi: {
                'Top Trends': 'Top Trends',
                'Trending Board': 'Trending Board',
                'For U': 'Dành cho bạn',
                'For You': 'Dành cho bạn',
                'About': 'Giới thiệu',
                'Sign In': 'Đăng nhập',
                'Sign Out': 'Đăng xuất',
                'Sign in with Work/School': 'Đăng nhập với tài khoản công việc/trường học',
                'Sign in with Google': 'Đăng nhập với Google',
                'Welcome to TrendPulse': 'Chào mừng đến với TrendPulse',
                'Discover what’s next. Act before the rest.': 'Khám phá tương lai. Hành động trước đối thủ.',
                'Trending Now': 'Xu hướng hiện tại',
                'Show All Trends': 'Hiển thị tất cả xu hướng',
                'Load More': 'Tải thêm',
                'View Source': 'Xem nguồn',
                'Following': 'Đang theo dõi',
                '❤️ Follow': '❤️ Theo dõi',
                '🔍 Analyze': '🔍 Phân tích',
                'Welcome! Set Your Preferences': 'Chào mừng! Thiết lập sở thích của bạn',
                "Select the categories you're interested in for a personalized experience.": 'Chọn các danh mục bạn quan tâm để có trải nghiệm cá nhân hóa.',
                'Save Preferences': 'Lưu sở thích',
                'Premium Access Required': 'Yêu cầu quyền truy cập Premium',
                'Please sign in with a company or school email to view the Trending Board.': 'Vui lòng đăng nhập bằng email công ty hoặc trường học để xem Trending Board.',
                'Log In': 'Đăng nhập',
                'Choose an account to continue to TrendPulse.': 'Chọn tài khoản để tiếp tục với TrendPulse.',
                'Trending Board Dashboard': 'Bảng điều khiển Trending Board',
                'Currently Hot Trends (Overall)': 'Xu hướng nóng hiện tại (Tổng thể)',
                'Your Followed Trends': 'Xu Hướng Bạn Theo Dõi',
                'Category Leaderboards': 'Bảng xếp hạng danh mục',
                'About TrendPulse': 'Giới thiệu TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": 'Nền tảng cộng đồng để dự đoán, trực quan hóa và phân tích xu hướng mới nổi. Nhấp vào tiêu đề xu hướng để có thông tin chi tiết từ AI.',
                'Quick Links': 'Liên kết nhanh',
                'Features': 'Tính năng',
                'AI Analysis': 'Phân tích AI',
                'Trend Prediction': 'Dự đoán xu hướng',
                'Leaderboards': 'Bảng xếp hạng',
                'Personal Recommendations': 'Gợi ý cá nhân',
                'Contact': 'Liên hệ',
                'Email: info@trendpulse.com': 'Email: info@trendpulse.com',
                'Support: support@trendpulse.com': 'Hỗ trợ: support@trendpulse.com',
                'All rights reserved.': 'Tất cả quyền được bảo lưu.',
                'AI: Checking...': 'AI: Đang kiểm tra...',
                'AI: Ready': 'AI: Sẵn sàng',
                'AI: Unavailable': 'AI: Không khả dụng',
                'AI: Connection error': 'AI: Lỗi kết nối',
                'AI Insight': 'AI Insight',
                'AI Insight for': 'AI Insight cho',
                'Analyzing trend...': 'Đang phân tích xu hướng...',
                'Trend Analysis for': 'Phân tích xu hướng cho',
                'Analyzing trend with API...': 'Đang phân tích xu hướng với API...',
                'Unable to analyze trend.': 'Không thể phân tích xu hướng.',
                'Trends for': 'Xu hướng cho',
                'Analysis': 'Phân tích',
                'Score': 'Điểm số',
                'Confidence': 'Độ tin cậy',
                'Summary': 'Tóm tắt',
                'Reach': 'Phạm vi tiếp cận',
                'Growth Rate': 'Tỷ lệ tăng trưởng',
                'Trend': 'Xu hướng',
                'Overall Score': 'Điểm số tổng thể',
                'Recommendations': 'Khuyến nghị'
            },
            en: {
                'Top Trends': 'Top Trends',
                'Trending Board': 'Trending Board',
                'For U': 'For U',
                'For You': 'For You',
                'About': 'About',
                'Sign In': 'Sign In',
                'Sign Out': 'Sign Out',
                'Sign in with Work/School': 'Sign in with Work/School',
                'Sign in with Google': 'Sign in with Google',
                'Welcome to TrendPulse': 'Welcome to TrendPulse',
                'Discover what’s next. Act before the rest.': 'Discover what’s next. Act before the rest.',
                'Trending Now': 'Trending Now',
                'Show All Trends': 'Show All Trends',
                'Load More': 'Load More',
                'View Source': 'View Source',
                'Following': 'Following',
                '❤️ Follow': '❤️ Follow',
                '🔍 Analyze': '🔍 Analyze',
                'Welcome! Set Your Preferences': 'Welcome! Set Your Preferences',
                "Select the categories you're interested in for a personalized experience.": "Select the categories you're interested in for a personalized experience.",
                'Save Preferences': 'Save Preferences',
                'Premium Access Required': 'Premium Access Required',
                'Please sign in with a company or school email to view the Trending Board.': 'Please sign in with a company or school email to view the Trending Board.',
                'Log In': 'Log In',
                'Choose an account to continue to TrendPulse.': 'Choose an account to continue to TrendPulse.',
                'Trending Board Dashboard': 'Trending Board Dashboard',
                'Currently Hot Trends (Overall)': 'Currently Hot Trends (Overall)',
                'Your Followed Trends': 'Your Followed Trends',
                'Category Leaderboards': 'Category Leaderboards',
                'About TrendPulse': 'About TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.",
                'Quick Links': 'Quick Links',
                'Features': 'Features',
                'AI Analysis': 'AI Analysis',
                'Trend Prediction': 'Trend Prediction',
                'Leaderboards': 'Leaderboards',
                'Personal Recommendations': 'Personal Recommendations',
                'Contact': 'Contact',
                'Email: info@trendpulse.com': 'Email: info@trendpulse.com',
                'Support: support@trendpulse.com': 'Support: support@trendpulse.com',
                'All rights reserved.': 'All rights reserved.',
                'AI: Checking...': 'AI: Checking...',
                'AI: Ready': 'AI: Ready',
                'AI: Unavailable': 'AI: Unavailable',
                'AI: Connection error': 'AI: Connection error',
                'AI Insight': 'AI Insight',
                'AI Insight for': 'AI Insight for',
                'Analyzing trend...': 'Analyzing trend...',
                'Trend Analysis for': 'Trend Analysis for',
                'Analyzing trend with API...': 'Analyzing trend with API...',
                'Unable to analyze trend.': 'Unable to analyze trend.',
                'Trends for': 'Trends for',
                'Analysis': 'Analysis',
                'Score': 'Score',
                'Confidence': 'Confidence',
                'Summary': 'Summary',
                'Reach': 'Reach',
                'Growth Rate': 'Growth Rate',
                'Trend': 'Trend',
                'Overall Score': 'Overall Score',
                'Recommendations': 'Recommendations'
            }
        };
        const i18nBindings = [
            { selector: '#nav-top-trends', key: 'Top Trends' },
            { selector: '#nav-trending-board', key: 'Trending Board' },
            { selector: '#nav-for-u a', key: 'For U' },
            { selector: '#nav-about', key: 'About' },
            { selector: '#sign-in-btn', key: 'Sign In' },
            { selector: '#dropdown-sign-out span:last-child', key: 'Sign Out' },
            { selector: '#dropdown-work-school span:last-child', key: 'Sign in with Work/School' },
            { selector: '#login-google-btn span', key: 'Sign in with Google' },
            { selector: '.demo-banner h2', key: 'Welcome to TrendPulse' },
            { selector: '.demo-banner p', key: 'Discover what’s next. Act before the rest.' },
            { selector: '#trending-header-text', key: 'Trending Now' },
            { selector: '#clear-filter-btn', key: 'Show All Trends' },
            { selector: '#load-more-btn', key: 'Load More' },
            { selector: '#for-u-load-more-btn', key: 'Load More' },
            { selector: '.for-u-container .trending-title-group span', key: 'For You' },
            { selector: '#preferences-modal .modal-title', key: 'Welcome! Set Your Preferences' },
            { selector: '#preferences-modal .modal-body', key: "Select the categories you're interested in for a personalized experience." },
            { selector: '#save-preferences-btn', key: 'Save Preferences' },
            { selector: '#premium-modal .modal-title', key: 'Premium Access Required' },
            { selector: '#premium-modal .modal-body', key: 'Please sign in with a company or school email to view the Trending Board.' },
            { selector: '#premium-login-btn', key: 'Log In' },
            { selector: '#login-choice-modal .modal-title', key: 'Sign In' },
            { selector: '#login-choice-modal .modal-body', key: 'Choose an account to continue to TrendPulse.' },
            { selector: '#trending-board-modal .modal-title', key: 'Trending Board Dashboard' },
            { selector: '#for-u-leaderboard-panel h3', key: 'Category Leaderboards' },
            { selector: '#about-modal .modal-title', key: 'About TrendPulse' },
            { selector: '#about-modal .modal-body', key: "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights." },
            { selector: '.footer-section:nth-child(2) .footer-title', key: 'Quick Links' },
            { selector: '#footer-top-trends', key: 'Top Trends' },
            { selector: '#footer-trending-board', key: 'Trending Board' },
            { selector: '#footer-about', key: 'About' },
            { selector: '.footer-section:nth-child(3) .footer-title', key: 'Features' },
            { selector: '.footer-section:nth-child(3) .footer-links li:nth-child(1)', key: 'AI Analysis' },
            { selector: '.footer-section:nth-child(3) .footer-links li:nth-child(2)', key: 'Trend Prediction' },
            { selector: '.footer-section:nth-child(3) .footer-links li:nth-child(3)', key: 'Leaderboards' },
            { selector: '.footer-section:nth-child(3) .footer-links li:nth-child(4)', key: 'Personal Recommendations' },
            { selector: '.footer-section:nth-child(4) .footer-title', key: 'Contact' },
            { selector: '.footer-section:nth-child(4) .footer-contact p:nth-child(1)', key: 'Email: info@trendpulse.com' },
            { selector: '.footer-section:nth-child(4) .footer-contact p:nth-child(2)', key: 'Support: support@trendpulse.com' },
            { selector: '#ai-insight-title', key: 'AI Insight' },
        ];
        function t(key){ return (translations[currentLanguage] && translations[currentLanguage][key]) || key; }
        function applyTranslations(){ i18nBindings.forEach(b=>{ const el = document.querySelector(b.selector); if(el){ el.textContent = t(b.key); }}); const footerBottom = document.querySelector('.footer-bottom p'); if (footerBottom) footerBottom.textContent = `© 2024 TrendPulse. ${t('All rights reserved.')}`; const statusText = document.getElementById('ai-status-text'); if (statusText) statusText.textContent = t('AI: Checking...'); }
        function updateLanguageToggleUI(){ const btn = document.getElementById('language-toggle'); if(!btn) return; btn.textContent = currentLanguage==='vi' ? 'VN' : 'EN'; }
        let allTrends = [];
        let categories = [];
        const DOM = { body: document.body, mainNav: document.getElementById('main-nav'), hamburgerMenu: document.getElementById('hamburger-menu'), logo: document.getElementById('logo'), signInBtn: document.getElementById('sign-in-btn'), userMenu: document.getElementById('user-menu'), userEmailBtn: document.getElementById('user-email-btn'), dropdownHeader: document.getElementById('dropdown-user-email'), userDropdown: document.getElementById('user-dropdown'), dropdownSignOut: document.getElementById('dropdown-sign-out'), dropdownWorkSchool: document.getElementById('dropdown-work-school'), navTopTrends: document.getElementById('nav-top-trends'), navTrendingBoard: document.getElementById('nav-trending-board'), navForU: document.getElementById('nav-for-u'), navAbout: document.getElementById('nav-about'), modalCloses: document.querySelectorAll('.modal-close'), mainViewContainer: document.getElementById('main-view-container'), forUViewContainer: document.getElementById('for-u-view-container'), trendsList: document.getElementById('trends-list'), forUTrendsList: document.getElementById('for-u-trends-list'), loadMoreBtn: document.getElementById('load-more-btn'), forULoadMoreBtn: document.getElementById('for-u-load-more-btn'), filterButtonsContainer: document.getElementById('filter-buttons'), clearFilterBtn: document.getElementById('clear-filter-btn'), preferencesGrid: document.getElementById('preferences-grid'), savePreferencesBtn: document.getElementById('save-preferences-btn'), trendingHeaderText: document.getElementById('trending-header-text') };

        function openModal(modalId) { document.getElementById(modalId).classList.add('show'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }
        async function fetchLiveTrends() {
            try {
                const res = await fetch('/.netlify/functions/fetch-trends');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data.success && Array.isArray(data.trends)) {
                    return data.trends;
                }
                return [];
            } catch (e) {
                console.warn('Live trends not available.', e.message);
                return [];
            }
        }
        function createTrendCard(trend) { const trendCard = document.createElement('div'); trendCard.className = 'trend-card'; trendCard.dataset.trendId = trend.id; const { title: localizedTitle, description: localizedDesc } = getLocalizedTrendText(trend); const simpleInsight = getSimpleDateInsight(trend.date); const isFollowed = user.followedTrends.includes(trend.id); const pastStatus = getTrendPastStatus(trend.date); const pastBadge = pastStatus ? `<span class="tag status past">${currentLanguage==='vi' ? 'Đã qua thời' : 'Past'}</span>` : ''; trendCard.innerHTML = ` <div class="trend-card-header"> <h3 class="trend-title" data-title="${localizedTitle}">${localizedTitle}</h3> <div class="trend-meta"> <span class="trend-meta-submitter">by ${trend.submitter}</span> <span class="trend-meta-date"><br>on ${trend.date}</span> </div> </div> <p class="trend-description">${localizedDesc}</p> <div class="trend-ai-insight">${simpleInsight}</div> <div class="trend-footer"> <div class="trend-tags"> <span class="tag category">${trend.category}</span> ${pastBadge} ${trend.tags.map(tag => `<span class=\"tag hashtag\" data-tag=\"${tag}\">#${tag}</span>`).join('')} </div> <div class="trend-actions"> <a href="${trend.source}" target="_blank" rel="noopener noreferrer" class="btn btn-outline view-source-btn">${t('View Source')}</a> <button class="btn btn-outline analyze-trend-btn" data-trend-id="${trend.id}" data-analysis-type="general">${t('🔍 Analyze')}</button> <button class="btn btn-follow ${isFollowed ? 'followed' : ''}" data-id="${trend.id}">${isFollowed ? t('Following') : t('❤️ Follow')}</button> </div> </div>`; return trendCard; };
        function getSimpleDateInsight(dateString) { if (!dateString) return ''; const trendDate = new Date(dateString); const may2025 = new Date('2025-05-01'); const jan2025 = new Date('2025-01-01'); if (trendDate >= may2025) { return 'This trend is currently rising and expected to grow.'; } else if (trendDate < jan2025) { return 'This trend has already peaked and is considered part of a past wave.'; } return ''; };
        function getTrendPastStatus(dateString) { if (!dateString) return false; const trendDate = new Date(dateString); const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth() - 3); return trendDate < cutoff; };
        function displayTrends() { let listElement, footerButton, trendsToFilter; if (currentView === 'forU') { listElement = DOM.forUTrendsList; footerButton = DOM.forULoadMoreBtn; const preferenceTrends = allTrends.filter(t => user.preferences.includes(t.category)); const followedTrends = allTrends.filter(t => user.followedTrends.includes(t.id)); const combined = [...followedTrends, ...preferenceTrends]; const uniqueTrendIds = new Set(combined.map(t => t.id)); trendsToFilter = Array.from(uniqueTrendIds).map(id => allTrends.find(t => t.id === id)); generateCategoryLeaderboards('for-u-leaderboards', user.preferences); } else { listElement = DOM.trendsList; footerButton = DOM.loadMoreBtn; if (currentFilter.type === 'category' && currentFilter.value !== 'All') { trendsToFilter = allTrends.filter(t => t.category === currentFilter.value); } else if (currentFilter.type === 'tag') { trendsToFilter = allTrends.filter(t => t.tags.includes(currentFilter.value)); } else { trendsToFilter = allTrends; } } listElement.innerHTML = ''; displayedTrends[currentView] = 0; const trendsToDisplay = trendsToFilter.slice(0, TRENDS_PER_PAGE); trendsToDisplay.forEach(trend => { listElement.appendChild(createTrendCard(trend)); try { saveSeenTrendKey(makeTrendKey(trend)); } catch(_){} }); displayedTrends[currentView] = trendsToDisplay.length; footerButton.classList.toggle('hidden', displayedTrends[currentView] >= trendsToFilter.length || trendsToFilter.length === 0); };
        function switchView(view) { currentView = view; if (view === 'forU') { DOM.mainViewContainer.classList.add('hidden'); DOM.forUViewContainer.classList.remove('hidden'); } else { DOM.forUViewContainer.classList.add('hidden'); DOM.mainViewContainer.classList.remove('hidden'); } displayTrends(); };
        function loadMoreTrends() { let listElement, footerButton, trendsToFilter; if (currentView === 'forU') { listElement = DOM.forUTrendsList; footerButton = DOM.forULoadMoreBtn; const uniqueTrendIds = new Set([...allTrends.filter(t => user.preferences.includes(t.category)).map(t=>t.id), ...user.followedTrends]); trendsToFilter = Array.from(uniqueTrendIds).map(id => allTrends.find(t => t.id === id)); } else { listElement = DOM.trendsList; footerButton = DOM.loadMoreBtn; if (currentFilter.type === 'category' && currentFilter.value !== 'All') { trendsToFilter = allTrends.filter(t => t.category === currentFilter.value); } else if (currentFilter.type === 'tag') { trendsToFilter = allTrends.filter(t => t.tags.includes(currentFilter.value)); } else { trendsToFilter = allTrends; } } const nextTrends = trendsToFilter.slice(displayedTrends[currentView], displayedTrends[currentView] + TRENDS_PER_PAGE); nextTrends.forEach(trend => { listElement.appendChild(createTrendCard(trend)); try { saveSeenTrendKey(makeTrendKey(trend)); } catch(_){} }); displayedTrends[currentView] += nextTrends.length; footerButton.classList.toggle('hidden', displayedTrends[currentView] >= trendsToFilter.length); };
        function updateUIForFilter() { if (currentFilter.type === 'tag') { DOM.trendingHeaderText.textContent = `${t('Trends for')} #${currentFilter.value}`; DOM.clearFilterBtn.classList.remove('hidden'); DOM.filterButtonsContainer.classList.add('hidden'); } else { DOM.trendingHeaderText.textContent = t('Trending Now'); DOM.clearFilterBtn.classList.add('hidden'); DOM.filterButtonsContainer.classList.remove('hidden'); document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter.value)); } displayTrends(); };
        function populateCategoryFilters() { categories = Array.from(new Set(allTrends.map(t => t.category))).sort(); const allCats = ['All', ...categories]; DOM.filterButtonsContainer.innerHTML = ''; allCats.forEach(category => { const button = document.createElement('button'); button.className = 'filter-btn'; button.textContent = category; button.dataset.filter = category; if (category === currentFilter.value) button.classList.add('active'); DOM.filterButtonsContainer.appendChild(button); }); };
        function populatePreferenceCheckboxes() { categories = Array.from(new Set(allTrends.map(t => t.category))).sort(); DOM.preferencesGrid.innerHTML = ''; categories.forEach(category => { const item = document.createElement('div'); item.className = 'preference-item'; item.innerHTML = `<label><input type="checkbox" name="preference" value="${category}"> ${category}</label>`; DOM.preferencesGrid.appendChild(item); }); };
        function updateAuthUI() { DOM.body.className = ''; if (user.isLoggedIn) { DOM.body.classList.add('logged-in'); DOM.signInBtn.classList.add('hidden'); DOM.userMenu.classList.remove('hidden'); DOM.userEmailBtn.textContent = user.email; DOM.dropdownHeader.textContent = user.email; DOM.navForU.classList.toggle('hidden', user.accountType !== 'work'); DOM.dropdownWorkSchool.classList.toggle('hidden', user.accountType === 'work'); if (user.accountType === 'work') { DOM.body.classList.add('work-account-view'); } else if (user.accountType === 'personal') { DOM.body.classList.add('personal-account-view'); } } else { DOM.signInBtn.classList.remove('hidden'); DOM.userMenu.classList.add('hidden'); DOM.navForU.classList.add('hidden'); } displayTrends(); };
        function signIn(type) { user = { isLoggedIn: true, accountType: type, email: type === 'personal' ? 'privatemail@gmail.com' : 'pro@company.com', preferences: [], hasSetPreferences: false, followedTrends: [] }; closeModal('login-choice-modal'); updateAuthUI(); if (type === 'work' && !user.hasSetPreferences) { populatePreferenceCheckboxes(); openModal('preferences-modal'); } };
        function generateCategoryLeaderboards(containerId, categoriesToShow) { const container = document.getElementById(containerId); container.innerHTML = ''; categoriesToShow.sort().forEach(category => { const topTrends = allTrends.filter(t => t.category === category).sort((a,b) => (user.followedTrends.includes(b.id) - user.followedTrends.includes(a.id)) || getTrendMetric(b) - getTrendMetric(a)).slice(0,3); if(topTrends.length > 0) { const leaderboardDiv = document.createElement('div'); leaderboardDiv.className = 'leaderboard-widget'; let listItems = topTrends.map(t => `<li><span>${truncateText(t.title, 25)}</span><span class="stat-display">${getTrendMetric(t)} 🔥</span></li>`).join(''); leaderboardDiv.innerHTML = `<h4>Top in ${category}</h4><ol>${listItems}</ol>`; container.appendChild(leaderboardDiv); } }); };
        function getTopCategories(n = 3) { const counts = {}; allTrends.forEach(t => { counts[t.category] = (counts[t.category] || 0) + 1; }); return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([cat])=>cat); }
        function loadSeenTrends() { try { return JSON.parse(localStorage.getItem('seenTrends') || '[]'); } catch (_) { return []; } };
        function saveSeenTrendKey(key) { try { const seen = new Set(loadSeenTrends()); if (!seen.has(key)) { seen.add(key); localStorage.setItem('seenTrends', JSON.stringify(Array.from(seen))); } } catch (_) {} };
        function makeTrendKey(trend) { return `${(trend.title||'').trim()}|${(trend.source||'').trim()}|${(trend.date||'').trim()}`.toLowerCase(); };
        function seededRandom(seed){ let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
        function shuffleArray(arr, seed = Date.now() % 1000) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(seededRandom(seed + i) * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
        function applyTrendOrdering() { const seenKeys = new Set(loadSeenTrends()); const unseen = []; const seen = []; allTrends.forEach(t => { (seenKeys.has(makeTrendKey(t)) ? seen : unseen).push(t); }); const shuffledUnseen = shuffleArray(unseen); allTrends = [...shuffledUnseen, ...seen]; };
        function getAIInsight(trend, promptType = 'general') { /* Implementation depends on external main.js */ return Promise.resolve("AI analysis is currently being developed for this trend."); }
        function analyzeTrendWithAPI(trend, analysisType = 'general') { /* Implementation depends on external file */ return Promise.resolve({ type: 'general', overallScore: Math.random(), summary: "This is a fallback analysis." }); }
        function getAnalyzeFnBase() { return '/.netlify/functions'; }
        function truncateText(text, maxLength = 180) { if (!text) return ''; if (text.length <= maxLength) return text; const cut = text.slice(0, maxLength); const lastSpace = cut.lastIndexOf(' '); return (lastSpace > 0 ? cut.slice(0, lastSpace) : cut) + '…'; };
        function getTrendMetric(trend) { return Number(trend?.votes || 0); };
        function getMetricLabel() { return currentLanguage==='vi' ? 'Bình chọn' : 'Votes'; };
        function getLocalizedTrendText(trend) { if (currentLanguage === 'vi') { return { title: trend.title_vi || trend.title, description: trend.description_vi || trend.description }; } else { return { title: trend.title_en || trend.title, description: trend.description_en || trend.description }; } };
        function generateMonthRange(start, end) { const res = []; const s = new Date(start); const e = new Date(end); s.setDate(1); e.setDate(1); while (s <= e) { const y = s.getFullYear(); const m = String(s.getMonth()+1).padStart(2, '0'); res.push(`${y}-${m}`); s.setMonth(s.getMonth()+1); } return res; };
        function monthKeyToLabel(key) { const [y,m] = key.split('-'); return `${m}/${y.slice(-2)}`; };
        function aggregateVotesByMonth(trends, monthKeys) { const map = new Map(monthKeys.map(k => [k, 0])); trends.forEach(t => { const d = new Date(t.date || Date.now()); const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if (map.has(k)) map.set(k, map.get(k) + Number(getTrendMetric(t)||0)); }); return monthKeys.map(k => map.get(k)); };
        function generateSeriesForMonths(trend, monthKeys) { const baseVotes = Math.max(10, Number(getTrendMetric(trend)) || 100); const trendDate = new Date(trend.date || Date.now()); const anchorKey = `${trendDate.getFullYear()}-${String(trendDate.getMonth()+1).padStart(2,'0')}`; const anchorIndex = monthKeys.indexOf(anchorKey); const seed = (trend.id || 1) + (trend.title ? trend.title.length : 0); const arr = new Array(monthKeys.length).fill(0); for (let i = 0; i < monthKeys.length; i++) { const dist = anchorIndex === -1 ? (i - Math.floor(monthKeys.length/2)) : (i - anchorIndex); const decay = Math.exp(-Math.abs(dist) * 0.35); const noise = (Math.sin(seed + i*1.13) + Math.cos(seed*0.37 + i*0.71)) * 0.05; const value = baseVotes * (0.6 + 0.4*decay) * (1 + noise); arr[i] = anchorIndex === -1 ? 0 : Math.max(0, Math.round(value)); } return arr; }; // Added a check to return 0 if date is out of range
        function getColorPalette(count) { const base = [ { stroke: 'rgba(161,0,255,1)', fill: 'rgba(161,0,255,0.15)' }, { stroke: 'rgba(0,200,255,1)', fill: 'rgba(0,200,255,0.15)' }, { stroke: 'rgba(0,230,150,1)', fill: 'rgba(0,230,150,0.15)' }, { stroke: 'rgba(255,180,0,1)', fill: 'rgba(255,180,0,0.15)' }, { stroke: 'rgba(255,99,132,1)', fill: 'rgba(255,99,132,0.15)' }, { stroke: 'rgba(153,102,255,1)', fill: 'rgba(153,102,255,0.15)' } ]; if (count <= base.length) return base.slice(0, count); const extra = []; for (let i = 0; i < count - base.length; i++) { const hue = Math.floor((i / (count - base.length + 1)) * 360); extra.push({ stroke: `hsl(${hue}, 90%, 60%)`, fill: `hsla(${hue}, 90%, 60%, 0.15)` }); } return base.concat(extra); };
        function generateMiniSeries(trend, analysis) { const parseDate = (d) => d ? new Date(d) : null; const endDate = parseDate(trend.endDate) || new Date(); const startCandidate = parseDate(trend.startDate) || parseDate(trend.date); const startDate = startCandidate ? new Date(startCandidate) : new Date(endDate); if (!startCandidate) startDate.setMonth(endDate.getMonth() - 3); const monthKeys = generateMonthRange(new Date(startDate.getFullYear(), startDate.getMonth(), 1).toISOString().slice(0,10), new Date(endDate.getFullYear(), endDate.getMonth(), 1).toISOString().slice(0,10)); const labels = monthKeys.map(monthKeyToLabel); const base = Math.max(10, Math.min(2000000, getTrendMetric(trend) || 100)); const growth = (analysis && typeof analysis.growthRate === 'number') ? analysis.growthRate : 0.05; const seed = (trend.id || 1) + (trend.title ? trend.title.length : 0); const series = []; let value = Math.max(10, base * 0.5); for (let i = 0; i < labels.length; i++) { const noise = (Math.sin(seed + i * 1.7) + Math.cos(seed * 0.3 + i)) * 0.03; value = value * (1 + growth * 0.25 + noise); series.push(Number(value.toFixed(2))); } return { labels, series }; };
        function renderInlineTrendLineChart(containerEl, labels, series) { try { const chartWrap = document.createElement('div'); chartWrap.className = 'ai-insight-chart'; const canvas = document.createElement('canvas'); const cid = `ai-inline-chart-${Date.now()}-${Math.floor(Math.random()*1000)}`; canvas.id = cid; chartWrap.appendChild(canvas); containerEl.appendChild(chartWrap); const ctx = canvas.getContext('2d'); new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Interest', data: series, tension: 0.35, fill: false, borderColor: 'rgba(161, 0, 255, 1)', pointRadius: 2, pointBackgroundColor: 'rgba(161, 0, 255, 1)' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#8a8da0' } }, y: { grid: { color: 'rgba(45, 46, 73, 0.5)' }, ticks: { color: '#8a8da0' } } } } }); } catch(_){} };
        
        // MODIFIED: This function now has fully dynamic time ranges.
        createHotTrendsChart = () => {
            const canvas = document.getElementById('hot-trends-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (hotTrendsChart) hotTrendsChart.destroy();

            const followedTrends = allTrends.filter(trend => user.followedTrends.includes(trend.id));
            const chartTitleEl = document.querySelector('#hot-trends-container h4');
            let trendsForChart;
            let startDate, endDate;

            // NEW LOGIC: Determine which trends to show and calculate their time range
            if (user.isLoggedIn && user.accountType === 'work' && followedTrends.length > 0) {
                trendsForChart = followedTrends.slice(0, 10);
                if (chartTitleEl) chartTitleEl.textContent = t('Your Followed Trends');
            } else {
                trendsForChart = allTrends
                    .sort((a, b) => (getTrendMetric(b) || 0) - (getTrendMetric(a) || 0))
                    .slice(0, 6);
                if (chartTitleEl) chartTitleEl.textContent = t('Currently Hot Trends (Overall)');
            }

            // NEW LOGIC: Dynamically calculate the date range based on the selected trends
            const allDates = trendsForChart
                .map(t => new Date(t.date))
                .filter(d => !isNaN(d.getTime())); // Filter out invalid dates

            if (allDates.length > 0) {
                const minDate = new Date(Math.min(...allDates));
                const maxDate = new Date(Math.max(...allDates));
                
                // Add padding of 2 months before and after for better visualization
                startDate = new Date(minDate.getFullYear(), minDate.getMonth() - 2, 1);
                endDate = new Date(maxDate.getFullYear(), maxDate.getMonth() + 2, 1);
            } else {
                // Fallback if no trends have valid dates
                endDate = new Date();
                startDate = new Date();
                startDate.setMonth(endDate.getMonth() - 7); // Default to last 8 months
            }

            const monthKeys = generateMonthRange(startDate, endDate);
            const labels = monthKeys.map(monthKeyToLabel);
            
            let datasets;
            if (trendsForChart.length === 0) {
                datasets = [{ label: getMetricLabel(), data: [], borderColor: 'rgba(161,0,255,1)' }];
            } else {
                const palette = getColorPalette(trendsForChart.length);
                datasets = trendsForChart.map((t, idx) => ({
                    label: truncateText(t.title, 30),
                    data: generateSeriesForMonths(t, monthKeys),
                    borderColor: palette[idx].stroke,
                    backgroundColor: palette[idx].fill,
                    tension: 0.35,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    borderWidth: 2
                }));
            }

            function formatNumber(n){
                if(n>=1e6) return (n/1e6).toFixed(1)+'M';
                if(n>=1e3) return (n/1e3).toFixed(1)+'K';
                return String(n);
            }
            hotTrendsChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { color: '#8a8da0', boxWidth: 10, padding: 20 } },
                        tooltip: { backgroundColor: '#1f2037', titleColor: '#e3e8f0', bodyColor: '#e3e8f0', borderColor: 'rgba(161,0,255,0.5)', borderWidth: 1, padding: 10, callbacks: { label: (ctx) => `${getMetricLabel()}: ${formatNumber(ctx.parsed.y)}` } }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8a8da0' } },
                        y: { grid: { color: 'rgba(45,46,73,0.35)' }, ticks: { color: '#8a8da0', callback: (v) => formatNumber(v) }, beginAtZero: true }
                    },
                    elements: { line: { capBezierPoints: true }, point: { hitRadius: 12 } }
                }
            });
            const topCats = getTopCategories(3);
            generateCategoryLeaderboards('category-leaderboards', topCats.length ? topCats : ['Gaming','Technology','Fashion']);
        };
        
        handleTrendListInteraction = (e) => { 
            const titleElement = e.target.closest('.trend-title'); 
            if (titleElement && user.accountType === 'work') {
                const trendId = parseInt(titleElement.closest('.trend-card').dataset.trendId); 
                const trend = allTrends.find(t => t.id === trendId); 
                const modalBody = document.getElementById('ai-insight-body'); 
                document.getElementById('ai-insight-title').textContent = `${t('AI Insight for')} "${trend.title}"`; 
                modalBody.innerHTML = `<div class="loading-spinner"></div><p style="text-align: center; margin-top: 1rem; color: var(--text-muted-color);">${t('Analyzing trend...')}</p>`; 
                openModal('ai-insight-modal'); 
                getAIInsight(trend).then(insight => { 
                    modalBody.innerHTML = `<div class="ai-insight-content">${insight.replace(/\n/g, '<br>')}</div>`; 
                    const gen = generateMiniSeries(trend, {});
                    renderInlineTrendLineChart(modalBody, gen.labels, gen.series);
                }).catch(err => { 
                    modalBody.innerHTML = `<div style="text-align: center; color: #ff6b6b;"><p>${t('Unable to analyze trend.')}</p><p style="font-size: 0.9rem; margin-top: 0.5rem;">${err.message}</p></div>`; 
                    console.error(err); 
                }); 
            } 
            
            const analyzeButton = e.target.closest('.analyze-trend-btn');
            if (analyzeButton && user.isLoggedIn && user.accountType === 'work') {
                const trendId = parseInt(analyzeButton.dataset.trendId);
                const trend = allTrends.find(t => t.id === trendId);
                const modalBody = document.getElementById('ai-insight-body');
                document.getElementById('ai-insight-title').textContent = `${t('Trend Analysis for')} "${trend.title}"`;
                modalBody.innerHTML = `<div class="loading-spinner"></div><p style="text-align: center; margin-top: 1rem; color: var(--text-muted-color);">${t('Analyzing trend with API...')}</p>`;
                openModal('ai-insight-modal');
                
                analyzeTrendWithAPI(trend).then(analysis => {
                    let analysisHTML = `<div class="ai-insight-content"><h4>${t('Analysis')}</h4>
                        <p><strong>${t('Overall Score')}:</strong> ${(analysis.overallScore * 100).toFixed(1)}%</p>
                        <p><strong>${t('Summary')}:</strong> ${truncateText(analysis.summary, 180)}</p>
                    </div>`;
                    modalBody.innerHTML = analysisHTML;
                    const gen = generateMiniSeries(trend, analysis);
                    renderInlineTrendLineChart(modalBody, gen.labels, gen.series);
                }).catch(err => {
                    modalBody.innerHTML = `<div style="text-align: center; color: #ff6b6b;"><p>Không thể phân tích trend.</p><p style="font-size: 0.9rem; margin-top: 0.5rem;">${err.message}</p></div>`; 
                    console.error(err); 
                }); 
            } 
            
            if (e.target.matches('.tag.hashtag')) { 
                switchView('main'); 
                currentFilter = { type: 'tag', value: e.target.dataset.tag }; 
                updateUIForFilter(); 
            } 
            const followButton = e.target.closest('.btn-follow'); 
            if (followButton && user.isLoggedIn && user.accountType === 'work') { 
                const trendId = parseInt(followButton.dataset.id); 
                const isFollowed = user.followedTrends.includes(trendId); 
                if (isFollowed) { 
                    user.followedTrends = user.followedTrends.filter(id => id !== trendId); 
                } else { 
                    user.followedTrends.push(trendId); 
                } 
                followButton.classList.toggle('followed', !isFollowed); 
                followButton.textContent = !isFollowed ? t('Following') : t('❤️ Follow'); 
                if(currentView === 'forU') displayTrends(); 
            } 
        };

        DOM.hamburgerMenu.addEventListener('click', () => { DOM.hamburgerMenu.classList.toggle('active'); DOM.mainNav.classList.toggle('nav-active'); });
        DOM.logo.addEventListener('click', () => switchView('main'));
        DOM.navTopTrends.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
        DOM.navForU.addEventListener('click', (e) => { e.preventDefault(); switchView('forU'); });
        DOM.signInBtn.addEventListener('click', () => openModal('login-choice-modal'));
        DOM.userEmailBtn.addEventListener('click', () => DOM.userDropdown.classList.toggle('show'));
        DOM.dropdownSignOut.addEventListener('click', () => { user = { isLoggedIn: false, email: null, accountType: null, preferences: [], hasSetPreferences: false, followedTrends: [] }; updateAuthUI(); DOM.userDropdown.classList.remove('show'); switchView('main'); });
        DOM.dropdownWorkSchool.addEventListener('click', () => { signIn('work'); DOM.userDropdown.classList.remove('show'); });
        DOM.navAbout.addEventListener('click', () => openModal('about-modal'));
        DOM.navTrendingBoard.addEventListener('click', () => { if (user.accountType === 'work') { openModal('trending-board-modal'); createHotTrendsChart(); } else { openModal('premium-modal'); } });
        document.getElementById('premium-login-btn')?.addEventListener('click', () => { closeModal('premium-modal'); openModal('login-choice-modal'); });
        DOM.modalCloses.forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.close)));
        document.getElementById('login-google-btn')?.addEventListener('click', () => signIn('personal'));
        document.getElementById('login-work-btn')?.addEventListener('click', () => signIn('work'));
        DOM.loadMoreBtn.addEventListener('click', loadMoreTrends);
        DOM.forULoadMoreBtn.addEventListener('click', loadMoreTrends);
        DOM.savePreferencesBtn.addEventListener('click', () => { user.preferences = Array.from(document.querySelectorAll('#preferences-grid input:checked')).map(cb => cb.value); user.hasSetPreferences = true; closeModal('preferences-modal'); switchView('forU'); });
        [DOM.trendsList, DOM.forUTrendsList].forEach(list => list.addEventListener('click', handleTrendListInteraction));
        DOM.filterButtonsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { currentFilter = { type: 'category', value: e.target.dataset.filter }; updateUIForFilter(); } });
        DOM.clearFilterBtn.addEventListener('click', () => { currentFilter = { type: 'category', value: 'All' }; updateUIForFilter(); });
        document.addEventListener('click', (e) => { if(DOM.userMenu && !DOM.userMenu.contains(e.target)) { DOM.userDropdown.classList.remove('show'); }});
        document.getElementById('footer-top-trends')?.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
        document.getElementById('footer-trending-board')?.addEventListener('click', (e) => { e.preventDefault(); if (user.accountType === 'work') { openModal('trending-board-modal'); createHotTrendsChart(); } else { openModal('premium-modal'); } });
        document.getElementById('footer-about')?.addEventListener('click', (e) => { e.preventDefault(); openModal('about-modal'); });
        document.getElementById('language-toggle')?.addEventListener('click', () => { currentLanguage = currentLanguage === 'vi' ? 'en' : 'vi'; localStorage.setItem('lang', currentLanguage); applyTranslations(); updateLanguageToggleUI(); displayTrends(); if (document.getElementById('trending-board-modal')?.classList.contains('show')) { createHotTrendsChart(); } });
        
        async function initializeApp() {
            allTrends = await fetchLiveTrends();
            applyTrendOrdering();
            populateCategoryFilters();
            updateAuthUI();
            applyTranslations();
            updateLanguageToggleUI();
            setTimeout(checkAIStatus, 1000);
            const loader = document.getElementById('loader');
            if (loader) {
                loader.classList.add('loader-hidden');
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }
        }
        
        async function checkAIStatus() {
            // This function is a placeholder as the GeminiAPIManager is not defined in this snippet.
            // In your real code, this would check the AI service status.
            const statusIndicator = document.getElementById('ai-status-indicator');
            const statusText = document.getElementById('ai-status-text');
            statusIndicator.className = 'ai-status-indicator offline';
            statusText.textContent = t('AI: Unavailable');
        }
        
        initializeApp();
    });
    </script>
</body>
</html>


